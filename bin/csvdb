#!perl

use strict;
use warnings;

#  2021-1010: Command line interface to the CSVDB module.

use Term::ReadLine;

use CSVDB;

my $base_prompt = 'csvdb > ';
my $prompt = $base_prompt;      #  Might show currently loaded file?

my $done = 0;
my $table;

my %cmds = (
    'q'  => { exec => sub { $done = 1; }, short => 'Quit csvdb command line' },
    'h'  => { exec => sub { help(); },    short => 'Show help' },
    'o' => {
        exec  => sub { &open_file; },
        short => 'Open CSV file with a header'
    },
    'ow' => {
        exec  => sub { &open_file_without_header; },
        short => 'Open CSV file without a header'
    },
);

my %sql = (
    'select' => { exec => sub { &select; }, short => 'Select records' },
);

{
    my $term = Term::ReadLine->new('csvdb');

    print $prompt;
    my $input;

    while ( defined( $input = $term->readline($prompt) ) ) {

        # $input =~ s/\s+$//;

        print "DEBUG: input: $input\n";

        my @words = split( / /, $input );
        my $cmd = shift @words;

        #  We're dealing with two things here .. single letter commands (listed
        #  above in the cmds hash) and actual SQL operations (list in the sql
        #  hash). If they're not in either of the hashes, it's a bad command.

        if ( exists $cmds{ $cmd } ) {

            &{ $cmds{ $cmd }->{ exec } }( [ @words ] );
        }

        elsif ( exists $sql{ $cmd } ) {

            &{ $sql{ $cmd }->{ exec } }( [ @words ] );

        } else {

            print "ERROR: Didn't recognize the $cmd command.\n";
        }

        last if ($done);
    }
}

sub help
{
    print join( "\n", map { "$_ : $cmds{$_}->{short}"; } sort keys %cmds )
      . "\n";
}

sub open_file
{
    my ( $array_ref ) = @_;
    my $filename = $array_ref->[0];
    
    if ( !defined ( $filename ) ) {

        print "ERROR: Must specify a CSV filename\n";
        return;
    }

    if ( -e $filename ) {

        print "INFO: Hey, $filename exists! Cool.\n";
        $table = CSVDB->new ( $filename );

        if ( defined $table ) {

            print "INFO: Cool, object successfully created.\n";

        } else {

            print "ERROR: Ugh, problems: " . join ( "\n", @CSVDB::errors ) . "\n";
        }
    }
}

sub open_file_without_header
{
    my ( $array_ref ) = @_;
    my $filename = $array_ref->[0];
    
    if ( !defined ( $filename ) ) {

        print "ERROR: Must specify a CSV filename\n";
        return;
    }

    if ( -e $filename ) {

        print "INFO: Hey, $filename exists! Cool.\n";
        $table = CSVDB->new_no_header ( $filename );

        if ( defined $table ) {

            print "INFO: Cool, object successfully created.\n";

        } else {

            print "ERROR: Ugh, problems: " . join ( "\n", @CSVDB::errors ) . "\n";
        }
    }
}

sub select
{
    my ( @params ) = @_;

    my $result = $table->select ( fields => @params );

    foreach my $row ( @$result ) {

        print join ( "\t", @{ $row } ) . "\n";
    }
}
